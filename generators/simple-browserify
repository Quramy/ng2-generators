#!/bin/sh

# __DESCRIPTION__: Simple starter using browserify.

CMD_NAME=`basename $0`
APP_NAME=$1

if [ -z "${APP_NAME}" ]; then
  echo "usage: ${CMD_NAME} application_name" >&2
  exit 1
fi

if [ -d "${APP_NAME}" ]; then
  echo "${APP_NAME} already exists." >&2
  exit 1
fi

echo "Start to create new application '${APP_NAME}'." >&2

mkdir -p ${APP_NAME}

# install global
which dtsm        > /dev/null || npm -g i dtsm
which rimraf      > /dev/null || npm -g i rimraf
which tsc         > /dev/null || npm -g i typescript
which browserify  > /dev/null || npm -g i browserify
which nf          > /dev/null || npm -g i foreman

pushd ${APP_NAME} > /dev/null

### dotfiles {{{
cat << EOF > .editorconfig
root = true

[*]
charset = utf-8
end_of_line = lf
trim_trailing_whitespace = true

[*.ts]
indent_style = space
indent_size = 2
EOF

cat << EOF > .gitignore
### Node ###
# Logs
logs
*.log
npm-debug.log*

# Runtime data
pids
*.pid
*.seed

# Directory for instrumented libs generated by jscoverage/JSCover
lib-cov

# Coverage directory used by tools like istanbul
coverage

# node-waf configuration
.lock-wscript

# Compiled binary addons (http://nodejs.org/api/addons.html)
build/Release

# Dependency directories
node_modules
jspm_packages

# Optional npm cache directory
.npm

# Optional REPL history
.node_repl_history


### Typings ###
## Ignore downloaded typings
typings

built/
EOF

### }}}

### Node.js {{{
cat << EOF > package.json
{
  "name": "${APP_NAME}",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "postinstall": "dtsm install",
    "clean": "rimraf bundle",
    "prestart": "tsc && browserify -d -o built/bundle.js built/index.js",
    "start": "browser-sync start --server --files bundle/*.js"
  },
  "keywords": [],
  "author": "",
  "license": "MIT",
  "dependencies": {
    "@angular/common":  "2.0.0-rc.5",
    "@angular/compiler":  "2.0.0-rc.5",
    "@angular/core":  "2.0.0-rc.5",
    "@angular/forms": "0.3.0",
    "@angular/http":  "2.0.0-rc.5",
    "@angular/platform-browser":  "2.0.0-rc.5",
    "@angular/platform-browser-dynamic":  "2.0.0-rc.5",
    "@angular/router":  "3.0.0-rc.1",
    "@angular/router-deprecated":  "2.0.0-rc.2",
    "@angular/upgrade":  "2.0.0-rc.5",
    "core-js": "^2.4.0",
    "reflect-metadata": "0.1.3",
    "rxjs": "5.0.0-beta.6",
    "zone.js": "0.6.12"
  },
  "devDependencies": {}
}
EOF
### }}}

### build script {{{
cat << 'EOF' > Procfile
web: browser-sync start --server --files built/bundle.js
typescript: tsc -w
bundle: watchify -v -o built/bundle.js built/index.js
EOF
### }}}

### TypeScript {{{
cat << 'EOF' > tsconfig.json
{
    "compilerOptions": {
        "module": "commonjs",
        "target": "es5",
        "noImplicitAny": false,
        "sourceMap": true,
        "outDir": "built",
        "rootDir": "src",
        "moduleResolution": "node",
        "experimentalDecorators": true,
        "emitDecoratorMetadata": true
    },
    "exclude": [
        "node_modules"
    ]
}
EOF
### }}}

### App Sources {{{

mkdir -p src/app

cat << 'EOF' > index.html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Angular2 First App</title>
</head>
<body>
<my-app>Loading...</my-app>
<script async src="built/bundle.js"></script>
</body>
</html>
EOF


cat << 'EOF' > src/app/my-app.component.ts
import {Component} from '@angular/core';

@Component({
  selector: 'my-app',
  styles: [
    `h1 {
      color: green;
    }`,
  ],
  template: `
  <div>
    <h1>Hello: {{name}}</h1>
    <input type="text" [(ngModel)]="name" />
  </div>
  `,
})
export class MyApp {
  private name = 'My Angular2 first app';
  constructor() {}
}
EOF

cat << 'EOF' > src/index.ts
import 'core-js';
import 'reflect-metadata';
import 'zone.js/dist/zone';
import 'rxjs';

import { NgModule } from '@angular/core';
import { FormsModule } from '@angular/forms';
import { BrowserModule } from '@angular/platform-browser';
import { MyApp } from './app/my-app.component';

import { platformBrowserDynamic } from '@angular/platform-browser-dynamic';

@NgModule({
  imports: [ BrowserModule, FormsModule ],
  declarations: [ MyApp ],
  bootstrap: [ MyApp ],
})
export class AppModule { }

platformBrowserDynamic().bootstrapModule(AppModule);
EOF

### }}}

echo "Prepare typings files with dtsm. It might take a while." >&2
dtsm init
dtsm install es6-shim --save || exit 1

echo "Install dependencies. It takes few minutes." >&2
npm i || exit 1

echo "" >&2
echo "Complete genaration, exec cd ${APP_NAME} and npm start ." >&2

popd >/dev/null

#:vim ft=sh
